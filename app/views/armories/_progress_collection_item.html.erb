<% materials_id = "materials-#{bucket}-#{index}" %>
<% materials = collection[:aggregated_materials].presence || aggregated_materials(collection[:materials]) %>
<% material_filter_values = progress_material_filter_values(collection).map(&:downcase).uniq %>
<% status_filter_values = progress_status_filter_values(collection).map(&:downcase).uniq %>

<li
  class="list-group-item"
  data-progress-entry="true"
  data-progress-status-values="<%= status_filter_values.join('|') %>"
  data-progress-material-values="<%= material_filter_values.join('|') %>">
  <div class="d-flex w-100 justify-content-between align-items-start">
    <div class="text-start me-3 flex-grow-1">
      <div class="d-flex align-items-baseline justify-content-between">
        <strong class="me-2"><%= collection[:tier] %> â€“ <%= collection[:name] %></strong>
        <div class="text-end ms-2">
          <span class="badge bg-secondary me-1"><%= t('armories.progress.badges.progress') %>: <%= collection[:progress] %>%</span>
          <span class="badge bg-info"><%= t('armories.progress.badges.missing') %>: <%= collection[:missing] %>%</span>
        </div>
      </div>

      <% badges_html = reward_badges(rewards: collection[:rewards], status: collection[:status]) %>
      <% if badges_html.present? %>
        <div class="mt-1">
          <%= badges_html %>
        </div>
      <% end %>

      <% if collection[:materials].present? %>
        <% visible_materials = materials.first(10) %>
        <div class="mt-2">
          <% visible_materials.each do |material| %>
            <span class="badge bg-warning text-dark me-1 mb-1 small">
              <%= material[:name] %> (+<%= material[:needed] %>)
            </span>
          <% end %>

          <% if materials.size > visible_materials.size %>
            <a class="small text-decoration-none ms-1" data-bs-toggle="collapse" href="#<%= materials_id %>" role="button" aria-expanded="false" aria-controls="<%= materials_id %>">
              <%= t('armories.progress.actions.show_all', count: materials.size) %>
            </a>
            <div class="collapse mt-2" id="<%= materials_id %>">
              <div class="d-flex flex-wrap">
                <% materials.drop(visible_materials.size).each do |material| %>
                  <div class="me-2 mb-2">
                    <span class="badge bg-warning text-dark small">
                      <%= material[:name] %> (+<%= material[:needed] %>)
                    </span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</li>
