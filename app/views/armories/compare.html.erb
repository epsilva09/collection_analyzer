<!doctype html>
<html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Armory Compare</title>
      <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
      <%= stylesheet_link_tag 'application', media: 'all' %>
      <%= stylesheet_link_tag 'armory', media: 'all' %>
    </head>
  <body>
    <main>
      <h1>Compare Collections</h1>
      <%= form_with url: compare_armory_path, method: :get, local: true do |f| %>
        <div>
          <%= f.label :name_a, 'Character A' %>
          <%= f.text_field :name_a, value: params[:name_a] %>
        </div>
        <div>
          <%= f.label :name_b, 'Character B' %>
          <%= f.text_field :name_b, value: params[:name_b] %>
        </div>
        <%= f.submit 'Compare' %>
      <% end %>

      <div class="controls">
        <button id="expand-all" class="toggle-btn" type="button">Expand all</button>
        <button id="collapse-all" class="toggle-btn" type="button">Collapse all</button>
      </div>

      <% if @error.present? %>
        <p class="error"><strong>Error:</strong> <%= @error %></p>
      <% end %>

      <% if @result %>
        <h2>Summary</h2>

        <div class="grid">
          <section class="card" data-card="common">
            <h3>
              <span>Common (<%= @result[:common].size %>)</span>
              <button class="toggle-btn js-toggle" data-target="common" type="button">Collapse</button>
            </h3>
            <div class="card-body">
              <ul>
                <% @result[:common].each do |v| %>
                  <li><%= v %></li>
                <% end %>
              </ul>
            </div>
          </section>

          <section class="card" data-card="only_a">
            <h3>
              <span>Only <%= @result[:name_a] %> (<%= @result[:only_a].size %>)</span>
              <button class="toggle-btn js-toggle" data-target="only_a" type="button">Collapse</button>
            </h3>
            <div class="card-body">
              <ul>
                <% @result[:only_a].each do |v| %>
                  <li><%= v %></li>
                <% end %>
              </ul>
            </div>
          </section>

          <section class="card" data-card="only_b">
            <h3>
              <span>Only <%= @result[:name_b] %> (<%= @result[:only_b].size %>)</span>
              <button class="toggle-btn js-toggle" data-target="only_b" type="button">Collapse</button>
            </h3>
            <div class="card-body">
              <ul>
                <% @result[:only_b].each do |v| %>
                  <li><%= v %></li>
                <% end %>
              </ul>
            </div>
          </section>
        </div>

        <h2>Detailed numeric comparison</h2>
        <table>
          <thead>
            <tr>
              <th>Attribute</th>
              <th style="background-color: #10b981;"><%= @result[:name_a] %></th>
              <th style="background-color: #ef4444;"><%= @result[:name_b] %></th>
              <th>Diff (A - B)</th>
            </tr>
          </thead>
          <tbody>
            <% @result[:detailed].each do |row| %>
              <% diff_val = row[:diff].to_f %>
              <% diff_class = diff_val > 0 ? 'diff-positive' : (diff_val < 0 ? 'diff-negative' : 'diff-zero') %>
              <tr>
                <td><%= row[:attribute] %></td>
                <td><%= row[:value_a].to_s %><%= row[:unit] == :percent ? '%' : '' %></td>
                <td><%= row[:value_b].to_s %><%= row[:unit] == :percent ? '%' : '' %></td>
                <td class="<%= diff_class %>"><%= (diff_val >= 0 ? '+' : '') + diff_val.to_s %><%= row[:unit] == :percent ? '%' : '' %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <script>
          (function(){
            function setCollapsed(cardEl, collapsed) {
              if (collapsed) {
                cardEl.classList.add('collapsed')
                var btn = cardEl.querySelector('.js-toggle')
                if (btn) btn.textContent = 'Expand'
              } else {
                cardEl.classList.remove('collapsed')
                var btn = cardEl.querySelector('.js-toggle')
                if (btn) btn.textContent = 'Collapse'
              }
            }

            document.querySelectorAll('.js-toggle').forEach(function(btn){
              btn.addEventListener('click', function(){
                var target = btn.getAttribute('data-target')
                var card = document.querySelector('[data-card="'+target+'"]')
                if (!card) return
                var collapsed = card.classList.contains('collapsed')
                setCollapsed(card, !collapsed)
              })
            })

            document.getElementById('expand-all').addEventListener('click', function(){
              document.querySelectorAll('section.card').forEach(function(c){ setCollapsed(c, false) })
            })

            document.getElementById('collapse-all').addEventListener('click', function(){
              document.querySelectorAll('section.card').forEach(function(c){ setCollapsed(c, true) })
            })
          })()
        </script>
      <% end %>
    </main>
  </body>
  <style>
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    section { background: #fff; padding: 12px; border-radius: 6px; }
  </style>
</html>
