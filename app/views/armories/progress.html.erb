<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Armory Progress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <%= stylesheet_link_tag 'application', media: 'all' %>
    <%= stylesheet_link_tag 'armory', media: 'all' %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <main class="text-center">
            <h1 class="my-4">Collection Progress</h1>
            <div class="row justify-content-center mb-4">
              <div class="col-12">
                <%= form_with url: progress_armory_path, method: :get, local: true, class: 'row g-3 justify-content-center' do |f| %>
                  <div class="col-12 col-md-5">
                    <%= f.label :name, 'Character', class: 'form-label' %>
                    <%= f.text_field :name, value: params[:name], class: 'form-control' %>
                  </div>
                  <div class="col-12 text-center">
                    <%= f.submit 'Search', class: 'btn btn-primary w-50' %>
                  </div>
                <% end %>
              </div>
            </div>

            <% if @error.present? %>
              <div class="alert alert-danger" role="alert">
                <strong>Error:</strong> <%= @error %>
              </div>
            <% end %>

            <% if @progress_data.present? %>
              <% labels = { low: '1–29% progress', mid: '30–59% progress', near: '≥ 80% progress' } %>
              <% @progress_data.each do |bucket, items| %>
                <% next if items.blank? %>
                <div class="row mb-4">
                  <div class="col-12">
                    <div class="card shadow">
                      <div class="card-header <%= bucket == :near ? 'bg-warning text-dark' : 'bg-dark text-white' %>">
                        <h2 class="h5 mb-0"><%= labels[bucket] %> (<%= items.size %>)</h2>
                      </div>
                      <ul class="list-group list-group-flush">
                        <% items.each_with_index do |col, idx| %>
                          <% mat_id = "materials-#{bucket}-#{idx}" %>
                          <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                              <div class="text-start me-3 flex-grow-1">
                                <div class="d-flex align-items-baseline justify-content-between">
                                  <strong class="me-2"><%= col[:tier] %> – <%= col[:name] %></strong>
                                  <div class="text-end ms-2">
                                    <span class="badge bg-secondary me-1">Progress: <%= col[:progress] %>%</span>
                                    <span class="badge bg-info">Missing: <%= col[:missing] %>%</span>
                                  </div>
                                </div>

                                <%# Rewards: show up to 3 inline badges, rest collapsed into a small text %>
                                <% if col[:status].present? %>
                                  <div class="mt-1">
                                    <% rewards = col[:status].split(',').map(&:strip) rescue [col[:status]] %>
                                    <% rewards.first(3).each do |r| %>
                                      <span class="badge bg-dark text-white me-1 small"><%= r %></span>
                                    <% end %>
                                    <% if rewards.size > 3 %>
                                      <span class="small text-muted">+<%= rewards.size - 3 %> more</span>
                                    <% end %>
                                  </div>
                                <% end %>

                                <%# Compact material chips: show up to 6, with collapse for the rest %>
                                <% if col[:materials].present? %>
                                  <div class="mt-2">
                                    <% visible = col[:materials].first(6) %>
                                    <% visible.each do |m| %>
                                      <span class="badge bg-warning text-dark me-1 mb-1 small"><%= m[:name] %> <span class="fw-bold"><%= m[:current] %>/<%= m[:max] %></span></span>
                                    <% end %>

                                    <% if col[:materials].size > visible.size %>
                                      <a class="small text-decoration-none ms-1" data-bs-toggle="collapse" href="#<%= mat_id %>" role="button" aria-expanded="false" aria-controls="<%= mat_id %>">
                                        Show all (<%= col[:materials].size %>)
                                      </a>
                                      <div class="collapse mt-2" id="<%= mat_id %>">
                                        <div class="d-flex flex-wrap">
                                          <% col[:materials].each do |m| %>
                                            <div class="me-2 mb-2">
                                              <span class="badge bg-warning text-dark small"><%= m[:name] %> <span class="fw-bold"><%= m[:current] %>/<%= m[:max] %></span></span>
                                            </div>
                                          <% end %>
                                        </div>
                                      </div>
                                    <% end %>
                                  </div>
                                <% end %>
                              </div>
                            </div>
                          </li>
                        <% end %>
                      </ul>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </main>
        </div>
      </div>
    </div>
  </body>
</html>
