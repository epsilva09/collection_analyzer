<% content_for :title, t('armories.progress.page_title') %>

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <main class="text-center armory-page">
            <%= render 'locale_switcher' %>
        <%= render 'page_header', heading: t('armories.progress.heading'), icon_class: nil %>

            <%= render 'menu',
                       current_page: :progress,
                       name: @name,
                       name_a: nil,
                       name_b: nil %>

            <%= render 'character_search_form',
                       url: progress_armory_path,
                       value: params[:name],
                       label: t('armories.progress.form.character'),
                       placeholder: t('armories.progress.form.placeholder'),
                       submit_text: t('armories.progress.form.search'),
                       loading_text: t('armories.shared.loading_search'),
                       turbo_disabled: true %>

            <% if @error.present? %>
              <%= render 'error_alert',
                         label: t('armories.progress.alerts.error'),
                         message: @error,
                         icon_class: nil,
                         dismissible: false %>
            <% end %>

            <% if @progress_data.present? %>
              <% labels = { near: t('armories.progress.labels.near'), mid: t('armories.progress.labels.mid'), low: t('armories.progress.labels.low'), below_one: t('armories.progress.labels.below_one') } %>
              <% ordered_buckets = [:near, :mid, :low, :below_one] %>
              <% filter_options = progress_filter_options(@progress_data) %>
              <% important_attributes = progress_important_attributes %>
              <% total_entries = ordered_buckets.sum { |bucket| (@progress_data[bucket] || []).size } %>

              <section
                data-controller="progress-filters"
                data-progress-filters-total-count-value="<%= total_entries %>"
                data-progress-filters-important-statuses-value="<%= important_attributes.join('|').downcase %>"
                data-progress-filters-results-template-value="<%= t('armories.progress.filters.results_summary').gsub('%{count}', 'COUNT') %>">
                <div class="card mb-3 text-start progress-filters-card progress-filters-sticky armory-section-card">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 progress-filters-toolbar mb-2">
                      <h2 class="h6 mb-0"><%= t('armories.progress.heading') %></h2>
                      <span class="badge bg-secondary-subtle text-light-emphasis progress-filters-counter">
                        <span data-progress-filters-target="visibleCount">0</span>
                        /
                        <span data-progress-filters-target="totalCount"><%= total_entries %></span>
                      </span>
                    </div>

                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-5">
                        <label for="progress-status-filter" class="form-label mb-1"><%= t('armories.progress.filters.status_label') %></label>
                        <input
                          id="progress-status-filter"
                          type="text"
                          class="form-control"
                          list="progress-status-options"
                          placeholder="<%= t('armories.progress.filters.status_placeholder') %>"
                          data-progress-filters-target="statusInput"
                          data-action="input->progress-filters#applyFilters focus->progress-filters#refreshStatusAutocomplete">
                        <datalist id="progress-status-options" data-progress-filters-target="statusDatalist">
                          <% filter_options[:status].each do |status_option| %>
                            <option value="<%= status_option %>"></option>
                          <% end %>
                        </datalist>
                      </div>

                      <div class="col-12 col-md-5">
                        <label for="progress-item-filter" class="form-label mb-1"><%= t('armories.progress.filters.item_label') %></label>
                        <input
                          id="progress-item-filter"
                          type="text"
                          class="form-control"
                          list="progress-item-options"
                          placeholder="<%= t('armories.progress.filters.item_placeholder') %>"
                          data-progress-filters-target="itemInput"
                          data-action="input->progress-filters#applyFilters focus->progress-filters#refreshItemAutocomplete">
                        <datalist id="progress-item-options" data-progress-filters-target="itemDatalist">
                          <% filter_options[:items].each do |item_option| %>
                            <option value="<%= item_option %>"></option>
                          <% end %>
                        </datalist>
                      </div>

                      <div class="col-12 col-md-2 d-grid gap-2 progress-filters-actions">
                        <button type="button" id="progress-clear-filters" class="btn btn-outline-light" data-action="click->progress-filters#clearFilters">
                          <%= t('armories.progress.filters.clear') %>
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-secondary"
                          data-bs-toggle="collapse"
                          data-bs-target="#progress-advanced-filters"
                          aria-expanded="false"
                          aria-controls="progress-advanced-filters">
                          <%= t('armories.progress.filters.advanced_toggle') %>
                        </button>
                      </div>
                    </div>

                    <div class="form-text mt-2"><%= t('armories.progress.filters.multi_hint') %></div>

                    <div class="progress-filter-presets mt-2">
                      <div class="small mb-1"><%= t('armories.progress.filters.presets_label') %></div>
                      <div class="d-flex flex-wrap gap-1">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary progress-preset-btn"
                                data-progress-filters-target="presetButton"
                                data-preset="all"
                                data-action="click->progress-filters#applyPreset">
                          <%= t('armories.progress.filters.preset_all') %>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary progress-preset-btn"
                                data-progress-filters-target="presetButton"
                                data-preset="important"
                                data-action="click->progress-filters#applyPreset">
                          <%= t('armories.progress.filters.preset_important') %>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary progress-preset-btn"
                                data-progress-filters-target="presetButton"
                                data-preset="with_items"
                                data-action="click->progress-filters#applyPreset">
                          <%= t('armories.progress.filters.preset_with_items') %>
                        </button>
                      </div>
                    </div>

                    <div class="progress-filter-chips mt-2">
                      <div class="small mb-1"><%= t('armories.progress.filters.active_status') %></div>
                      <div class="d-flex flex-wrap gap-1" data-progress-filters-target="statusChips"></div>
                      <div class="small mb-1 mt-2"><%= t('armories.progress.filters.active_items') %></div>
                      <div class="d-flex flex-wrap gap-1" data-progress-filters-target="itemChips"></div>
                      <p class="small mt-2 mb-0" data-progress-filters-target="resultsSummary" aria-live="polite"></p>
                    </div>

                    <div class="collapse mt-3" id="progress-advanced-filters">
                      <div class="row g-2">
                        <div class="col-12 col-md-6">
                          <label for="progress-status-filter-multi" class="form-label mb-1 small"><%= t('armories.progress.filters.status_multi_label') %></label>
                          <select
                            id="progress-status-filter-multi"
                            class="form-select"
                            multiple
                            size="5"
                            aria-label="<%= t('armories.progress.filters.status_multi_label') %>"
                            data-progress-filters-target="statusMulti"
                            data-action="change->progress-filters#applyFilters keydown->progress-filters#handleMultiSelectKeydown">
                            <% filter_options[:status].each do |status_option| %>
                              <option value="<%= status_option.downcase %>"><%= status_option %></option>
                            <% end %>
                          </select>
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="progress-item-filter-multi" class="form-label mb-1 small"><%= t('armories.progress.filters.item_multi_label') %></label>
                          <select
                            id="progress-item-filter-multi"
                            class="form-select"
                            multiple
                            size="5"
                            aria-label="<%= t('armories.progress.filters.item_multi_label') %>"
                            data-progress-filters-target="itemMulti"
                            data-action="change->progress-filters#applyFilters keydown->progress-filters#handleMultiSelectKeydown">
                            <% filter_options[:items].each do |item_option| %>
                              <option value="<%= item_option.downcase %>"><%= item_option %></option>
                            <% end %>
                          </select>
                        </div>
                      </div>
                      <div class="form-text mt-1"><%= t('armories.progress.filters.shortcuts_hint') %></div>
                    </div>
                  </div>
                </div>

                <div class="accordion" id="progress-groups">
                <% ordered_buckets.each_with_index do |bucket, group_index| %>
                  <% items = @progress_data[bucket] || [] %>
                  <% next if items.blank? %>
                  <%= render 'progress_bucket',
                             bucket: bucket,
                             label: labels[bucket],
                             items: items,
                             group_index: group_index %>
                <% end %>
                </div>

                <div class="armory-empty-state text-center mt-3" data-progress-filters-target="emptyState" hidden>
                  <i class="fas fa-filter fa-2x mb-2" aria-hidden="true"></i>
                  <h3 class="h6 mb-1"><%= t('armories.progress.filters.empty_title') %></h3>
                  <p class="mb-3"><%= t('armories.progress.filters.empty_description') %></p>
                  <button type="button" class="btn btn-outline-light btn-sm" data-action="click->progress-filters#clearFilters">
                    <%= t('armories.progress.filters.clear_and_show_all') %>
                  </button>
                </div>
              </section>
            <% end %>
      </main>
    </div>
  </div>
</div>
