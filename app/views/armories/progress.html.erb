<% content_for :title, t('armories.progress.page_title') %>

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <main class="text-center">
            <%= render 'locale_switcher' %>
            <h1 class="my-4"><%= t('armories.progress.heading') %></h1>

            <%= render 'menu', current_page: :progress, name: @name %>

            <%= render 'character_search_form',
                       url: progress_armory_path,
                       value: params[:name],
                       label: t('armories.progress.form.character'),
                       placeholder: t('armories.progress.form.placeholder'),
                       submit_text: t('armories.progress.form.search') %>

            <% if @error.present? %>
              <div class="alert alert-danger" role="alert">
                <strong><%= t('armories.progress.alerts.error') %>:</strong> <%= @error %>
              </div>
            <% end %>

            <% if @progress_data.present? %>
              <% labels = { near: t('armories.progress.labels.near'), mid: t('armories.progress.labels.mid'), low: t('armories.progress.labels.low'), below_one: t('armories.progress.labels.below_one') } %>
              <% ordered_buckets = [:near, :mid, :low, :below_one] %>
              <% all_entries = @progress_data.values.flatten %>
                  <% status_filter_options = all_entries.flat_map do |entry|
                    reward_descriptions = Array(entry[:rewards]).map { |reward| reward[:description].to_s.strip }.reject(&:blank?)
                    reward_descriptions = entry[:status].to_s.split(',').map(&:strip).reject(&:blank?) if reward_descriptions.blank?
                    reward_descriptions.map { |label| normalize_reward_attribute(label) }.reject(&:blank?)
                 end.uniq.sort_by(&:downcase) %>
              <% item_filter_options = all_entries.flat_map do |entry|
                   aggregated_materials(entry[:materials]).map { |material| material[:name].to_s.strip }
                 end.reject(&:blank?).uniq.sort_by(&:downcase) %>

              <div class="card mb-3 text-start">
                <div class="card-body">
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-5">
                      <label for="progress-status-filter" class="form-label mb-1"><%= t('armories.progress.filters.status_label') %></label>
                      <input
                        id="progress-status-filter"
                        type="text"
                        class="form-control"
                        list="progress-status-options"
                        placeholder="<%= t('armories.progress.filters.status_placeholder') %>">
                      <div class="form-text"><%= t('armories.progress.filters.multi_hint') %></div>
                      <datalist id="progress-status-options">
                        <% status_filter_options.each do |status_option| %>
                          <option value="<%= status_option %>"></option>
                        <% end %>
                      </datalist>
                      <select id="progress-status-filter-multi" class="form-select mt-2" multiple size="5" aria-label="<%= t('armories.progress.filters.status_multi_label') %>">
                        <% status_filter_options.each do |status_option| %>
                          <option value="<%= status_option.downcase %>"><%= status_option %></option>
                        <% end %>
                      </select>
                    </div>

                    <div class="col-12 col-md-5">
                      <label for="progress-item-filter" class="form-label mb-1"><%= t('armories.progress.filters.item_label') %></label>
                      <input
                        id="progress-item-filter"
                        type="text"
                        class="form-control"
                        list="progress-item-options"
                        placeholder="<%= t('armories.progress.filters.item_placeholder') %>">
                      <div class="form-text"><%= t('armories.progress.filters.multi_hint') %></div>
                      <datalist id="progress-item-options">
                        <% item_filter_options.each do |item_option| %>
                          <option value="<%= item_option %>"></option>
                        <% end %>
                      </datalist>
                      <select id="progress-item-filter-multi" class="form-select mt-2" multiple size="5" aria-label="<%= t('armories.progress.filters.item_multi_label') %>">
                        <% item_filter_options.each do |item_option| %>
                          <option value="<%= item_option.downcase %>"><%= item_option %></option>
                        <% end %>
                      </select>
                    </div>

                    <div class="col-12 col-md-2 d-grid">
                      <button type="button" id="progress-clear-filters" class="btn btn-outline-light"><%= t('armories.progress.filters.clear') %></button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="accordion" id="progress-groups">
                <% ordered_buckets.each_with_index do |bucket, group_index| %>
                  <% items = @progress_data[bucket] || [] %>
                  <% next if items.blank? %>
                  <% collapse_id = "progress-#{bucket}" %>
                  <% heading_id = "heading-#{bucket}" %>

                  <div class="accordion-item mb-3 border-0 bg-transparent" data-progress-bucket="<%= bucket %>">
                    <h2 class="accordion-header" id="<%= heading_id %>">
                      <button
                        class="accordion-button progress-title-btn <%= group_index.zero? ? '' : 'collapsed' %>"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#<%= collapse_id %>"
                        aria-expanded="<%= group_index.zero? ? 'true' : 'false' %>"
                        aria-controls="<%= collapse_id %>">
                        <span class="me-2"><%= labels[bucket] %></span>
                        <span
                          class="badge <%= bucket == :near ? 'bg-warning text-dark' : 'bg-secondary' %>"
                          data-progress-count-badge="true"
                          data-original-count="<%= items.size %>"><%= items.size %></span>
                      </button>
                    </h2>

                    <div
                      id="<%= collapse_id %>"
                      class="accordion-collapse collapse <%= group_index.zero? ? 'show' : '' %>"
                      aria-labelledby="<%= heading_id %>">
                      <div class="accordion-body p-0">
                        <ul class="list-group list-group-flush">
                          <% items.each_with_index do |col, idx| %>
                            <% mat_id = "materials-#{bucket}-#{idx}" %>
                            <% materials = aggregated_materials(col[:materials]) %>
                            <% material_filter_values = materials.map { |m| m[:name].to_s.downcase.strip }.uniq %>
                            <% status_filter_values = Array(col[:rewards]).map { |reward| normalize_reward_attribute(reward[:description]).downcase.strip }.reject(&:blank?) %>
                            <% status_filter_values = col[:status].to_s.split(',').map { |status| normalize_reward_attribute(status).downcase.strip }.reject(&:blank?) if status_filter_values.blank? %>

                            <li
                              class="list-group-item"
                              data-progress-entry="true"
                              data-progress-status-values="<%= status_filter_values.join('|') %>"
                              data-progress-material-values="<%= material_filter_values.join('|') %>">
                              <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="text-start me-3 flex-grow-1">
                                  <div class="d-flex align-items-baseline justify-content-between">
                                    <strong class="me-2"><%= col[:tier] %> â€“ <%= col[:name] %></strong>
                                    <div class="text-end ms-2">
                                      <span class="badge bg-secondary me-1"><%= t('armories.progress.badges.progress') %>: <%= col[:progress] %>%</span>
                                      <span class="badge bg-info"><%= t('armories.progress.badges.missing') %>: <%= col[:missing] %>%</span>
                                    </div>
                                  </div>

                                  <% badges_html = reward_badges(rewards: col[:rewards], status: col[:status]) %>
                                  <% if badges_html.present? %>
                                    <div class="mt-1">
                                      <%= badges_html %>
                                    </div>
                                  <% end %>
                                  <% if col[:materials].present? %>
                                    <div class="mt-2">
                                      <% visible = materials.first(10) %>
                                      <% visible.each do |m| %>
                                        <span class="badge bg-warning text-dark me-1 mb-1 small">
                                          <%= m[:name] %> (+<%= m[:needed] %>)
                                        </span>
                                      <% end %>

                                      <% if materials.size > visible.size %>
                                        <a class="small text-decoration-none ms-1" data-bs-toggle="collapse" href="#<%= mat_id %>" role="button" aria-expanded="false" aria-controls="<%= mat_id %>">
                                          <%= t('armories.progress.actions.show_all', count: materials.size) %>
                                        </a>
                                        <div class="collapse mt-2" id="<%= mat_id %>">
                                          <div class="d-flex flex-wrap">
                                            <% materials.drop(visible.size).each do |m| %>
                                              <div class="me-2 mb-2">
                                                <span class="badge bg-warning text-dark small">
                                                  <%= m[:name] %> (+<%= m[:needed] %>)
                                                </span>
                                              </div>
                                            <% end %>
                                          </div>
                                        </div>
                                      <% end %>
                                    </div>
                                  <% end %>
                                </div>
                              </div>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>

              <script>
                document.addEventListener("turbo:load", function() {
                  const statusFilter = document.getElementById("progress-status-filter");
                  const statusFilterMulti = document.getElementById("progress-status-filter-multi");
                  const statusOptionsDatalist = document.getElementById("progress-status-options");
                  const itemFilter = document.getElementById("progress-item-filter");
                  const itemFilterMulti = document.getElementById("progress-item-filter-multi");
                  const itemOptionsDatalist = document.getElementById("progress-item-options");
                  const clearFiltersButton = document.getElementById("progress-clear-filters");

                  if (!statusFilter || !statusFilterMulti || !statusOptionsDatalist || !itemFilter || !itemFilterMulti || !itemOptionsDatalist || !clearFiltersButton) {
                    return;
                  }

                  const normalize = (value) => (value || "").toString().trim().toLowerCase();
                  const unique = (values) => Array.from(new Set(values.filter(Boolean)));

                  const parseValues = (rawValue) => normalize(rawValue).split("|").map((value) => value.trim()).filter(Boolean);
                  const parseCsvTokens = (rawValue) => normalize(rawValue).split(",").map((value) => value.trim()).filter(Boolean);
                  const selectedOptions = (selectElement) => Array.from(selectElement.selectedOptions).map((option) => normalize(option.value));
                  const statusAutocompleteOptions = Array.from(statusOptionsDatalist.options).map((option) => option.value).filter(Boolean);
                  const itemAutocompleteOptions = Array.from(itemOptionsDatalist.options).map((option) => option.value).filter(Boolean);

                  const buildCsvSuggestion = (rawValue, suggestion) => {
                    const parts = (rawValue || "").split(",");
                    if (parts.length <= 1) {
                      return suggestion;
                    }

                    const prefix = parts.slice(0, -1).map((part) => part.trim()).filter(Boolean).join(", ");
                    return prefix ? `${prefix}, ${suggestion}` : suggestion;
                  };

                  const refreshAutocompleteOptions = (inputElement, datalistElement, sourceOptions) => {
                    const rawValue = inputElement.value || "";
                    const tokens = rawValue.split(",").map((token) => token.trim());
                    const currentToken = normalize(tokens[tokens.length - 1]);
                    const selectedTokens = tokens.slice(0, -1).map((token) => normalize(token)).filter(Boolean);

                    const filteredOptions = sourceOptions.filter((option) => {
                      const normalizedOption = normalize(option);
                      if (selectedTokens.includes(normalizedOption)) {
                        return false;
                      }

                      return !currentToken || normalizedOption.includes(currentToken);
                    }).slice(0, 100);

                    datalistElement.innerHTML = "";
                    filteredOptions.forEach((option) => {
                      const suggestion = document.createElement("option");
                      suggestion.value = buildCsvSuggestion(rawValue, option);
                      datalistElement.appendChild(suggestion);
                    });
                  };

                  const applyFilters = () => {
                    const statusQueries = unique([ ...parseCsvTokens(statusFilter.value), ...selectedOptions(statusFilterMulti) ]);
                    const materialQueries = unique([ ...parseCsvTokens(itemFilter.value), ...selectedOptions(itemFilterMulti) ]);

                    document.querySelectorAll("[data-progress-entry='true']").forEach((entry) => {
                      const statusValues = parseValues(entry.dataset.progressStatusValues);
                      const materialValues = parseValues(entry.dataset.progressMaterialValues);

                      const statusMatches = statusQueries.length === 0 || statusQueries.some((query) => statusValues.some((value) => value.includes(query)));
                      const materialMatches = materialQueries.length === 0 || materialQueries.some((query) => materialValues.some((value) => value.includes(query)));
                      const visible = statusMatches && materialMatches;

                      entry.hidden = !visible;
                    });

                    document.querySelectorAll("[data-progress-bucket]").forEach((bucket) => {
                      const visibleEntries = Array.from(bucket.querySelectorAll("[data-progress-entry='true']")).filter((entry) => !entry.hidden).length;
                      const badge = bucket.querySelector("[data-progress-count-badge='true']");

                      if (badge) {
                        badge.textContent = visibleEntries;
                      }

                      bucket.hidden = visibleEntries === 0;
                    });

                    refreshAutocompleteOptions(statusFilter, statusOptionsDatalist, statusAutocompleteOptions);
                    refreshAutocompleteOptions(itemFilter, itemOptionsDatalist, itemAutocompleteOptions);
                  };

                  statusFilter.addEventListener("input", applyFilters);
                  statusFilterMulti.addEventListener("change", applyFilters);
                  itemFilter.addEventListener("input", applyFilters);
                  itemFilterMulti.addEventListener("change", applyFilters);
                  statusFilter.addEventListener("focus", () => refreshAutocompleteOptions(statusFilter, statusOptionsDatalist, statusAutocompleteOptions));
                  itemFilter.addEventListener("focus", () => refreshAutocompleteOptions(itemFilter, itemOptionsDatalist, itemAutocompleteOptions));

                  clearFiltersButton.addEventListener("click", () => {
                    statusFilter.value = "";
                    itemFilter.value = "";
                    Array.from(statusFilterMulti.options).forEach((option) => {
                      option.selected = false;
                    });
                    Array.from(itemFilterMulti.options).forEach((option) => {
                      option.selected = false;
                    });
                    applyFilters();
                  });

                  refreshAutocompleteOptions(statusFilter, statusOptionsDatalist, statusAutocompleteOptions);
                  refreshAutocompleteOptions(itemFilter, itemOptionsDatalist, itemAutocompleteOptions);
                });
              </script>
            <% end %>
      </main>
    </div>
  </div>
</div>
