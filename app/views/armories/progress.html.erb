<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title><%= t('armories.progress.page_title') %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <%= stylesheet_link_tag 'application', media: 'all' %>
    <%= stylesheet_link_tag 'armory', media: 'all' %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .progress-title-btn,
      .progress-title-btn:not(.collapsed) {
        background: #ffffff !important;
        color: #212529 !important;
        box-shadow: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <main class="text-center">
            <div class="d-flex justify-content-end mb-2">
              <span class="small me-2"><%= t('armories_shared.language') %>:</span>
              <%= link_to t('armories_shared.portuguese'), locale_switch_url(:'pt-BR'), class: "btn btn-sm #{I18n.locale.to_s == 'pt-BR' ? 'btn-primary' : 'btn-outline-primary'} me-1" %>
              <%= link_to t('armories_shared.english'), locale_switch_url(:en), class: "btn btn-sm #{I18n.locale.to_s == 'en' ? 'btn-primary' : 'btn-outline-primary'}" %>
            </div>
            <h1 class="my-4"><%= t('armories.progress.heading') %></h1>
            <div class="row justify-content-center mb-4">
              <div class="col-12">
                <%= form_with url: progress_armory_path, method: :get, local: true, class: 'row g-3 justify-content-center', data: { turbo: false } do |f| %>
                  <div class="col-12 col-md-5">
                    <%= f.label :name, t('armories.progress.form.character'), class: 'form-label' %>
                    <%= f.text_field :name, value: params[:name], class: 'form-control' %>
                  </div>
                  <div class="col-12 text-center">
                    <%= f.submit t('armories.progress.form.search'), class: 'btn btn-success w-50' %>
                  </div>
                <% end %>
              </div>
            </div>

            <div class="row justify-content-center mb-4">
              <div class="col-12 text-center">
                <%= link_to t('armories.materials.heading'), materials_armory_path(name: @name), class: 'btn btn-outline-success btn-sm me-2' %>
                <%= link_to t('armories.compare.actions.back_to_index'), armory_path, class: 'btn btn-outline-secondary btn-sm' %>
              </div>
            </div>

            <% if @error.present? %>
              <div class="alert alert-danger" role="alert">
                <strong><%= t('armories.progress.alerts.error') %>:</strong> <%= @error %>
              </div>
            <% end %>

            <% if @progress_data.present? %>
              <% labels = { near: t('armories.progress.labels.near'), mid: t('armories.progress.labels.mid'), low: t('armories.progress.labels.low'), below_one: t('armories.progress.labels.below_one') } %>
              <% ordered_buckets = [:near, :mid, :low, :below_one] %>

              <div class="accordion" id="progress-groups">
                <% ordered_buckets.each_with_index do |bucket, group_index| %>
                  <% items = @progress_data[bucket] || [] %>
                  <% next if items.blank? %>
                  <% collapse_id = "progress-#{bucket}" %>
                  <% heading_id = "heading-#{bucket}" %>

                  <div class="accordion-item mb-3 border-0 bg-transparent">
                    <h2 class="accordion-header" id="<%= heading_id %>">
                      <button
                        class="accordion-button progress-title-btn <%= group_index.zero? ? '' : 'collapsed' %>"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#<%= collapse_id %>"
                        aria-expanded="<%= group_index.zero? ? 'true' : 'false' %>"
                        aria-controls="<%= collapse_id %>">
                        <span class="me-2"><%= labels[bucket] %></span>
                        <span class="badge <%= bucket == :near ? 'bg-warning text-dark' : 'bg-secondary' %>"><%= items.size %></span>
                      </button>
                    </h2>

                    <div
                      id="<%= collapse_id %>"
                      class="accordion-collapse collapse <%= group_index.zero? ? 'show' : '' %>"
                      aria-labelledby="<%= heading_id %>">
                      <div class="accordion-body p-0">
                        <ul class="list-group list-group-flush">
                          <% items.each_with_index do |col, idx| %>
                            <% mat_id = "materials-#{bucket}-#{idx}" %>
                            <li class="list-group-item">
                              <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="text-start me-3 flex-grow-1">
                                  <div class="d-flex align-items-baseline justify-content-between">
                                    <strong class="me-2"><%= col[:tier] %> â€“ <%= col[:name] %></strong>
                                    <div class="text-end ms-2">
                                      <span class="badge bg-secondary me-1"><%= t('armories.progress.badges.progress') %>: <%= col[:progress] %>%</span>
                                      <span class="badge bg-info"><%= t('armories.progress.badges.missing') %>: <%= col[:missing] %>%</span>
                                    </div>
                                  </div>

                                  <% if col[:rewards].present? %>
                                    <div class="mt-1">
                                      <% col[:rewards].each do |reward| %>
                                        <span class="badge <%= reward[:unlocked] ? 'bg-success' : 'bg-dark text-white' %> me-1 small"><%= reward[:description] %></span>
                                      <% end %>
                                    </div>
                                  <% elsif col[:status].present? %>
                                    <div class="mt-1">
                                      <% rewards = col[:status].split(',').map(&:strip) rescue [col[:status]] %>
                                      <% rewards.each do |r| %>
                                        <span class="badge bg-dark text-white me-1 small"><%= r %></span>
                                      <% end %>
                                    </div>
                                  <% end %>

                                  <%# Materials details moved to the dedicated materials route %>
                                </div>
                              </div>
                            </li>
                          <% end %>
                        </ul>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </main>
        </div>
      </div>
    </div>
  </body>
</html>
